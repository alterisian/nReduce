- content_for :subtitle do
  #{@startup.name}

.demo_day
  .row.header
    .span3{:style => 'padding-top: 20px'}= link_to '<i class="icon-chevron-left"></i> View All nStars'.html_safe, demo_day_index_path, :class => 'btn btn-large'
    .span6
      %center
        %h1 #{@startup.name}
        %p{:style => 'margin-bottom: 2px'}= h(@startup.one_liner)
        - if @startup.website_url.present?
          %p= link_to_external @startup.website_url, @startup.website_url
    / .span3
    /   %center
    /     Investors Only
    /     %br/
    /     = link_to "Contact #{@startup.name}", '#', :class => 'btn btn-large'
  %hr/

  .row
    .span6
      %div{:style => 'width: 500px'}
        %center
          %h3 Live Q&A with the founders of #{@startup.name}
      .video_wrapper
        #video
          .loading Loading Live Stream...
      - if @owner
        :javascript
          var publisher;
          function sessionConnectedHandler(event) {
            // Put my webcam in a div
            var publishProps = {width:500, height:315};
            publisher = TB.initPublisher(apiKey, 'video', publishProps);
            // Send my stream to the session
            session.publish(publisher);

            // Show video
            $('.loading').remove();

            // Record Session
            stream = null;
            for (var i = 0; i < event.streams; i++) {
              var stream = event.streams[i];
            }
            if(stream != null){
              //stream.startRecording();
            }
          }
      - else
        :javascript
          function streamCreated(event) {
            for (var i = 0; i < event.streams.length; i++) {
              var stream = event.streams[i];
              displayStream(stream);
            }
            streams = event.streams;
          }

          function displayStream(stream) {
            var div = document.createElement('div');
            div.setAttribute('id', 'stream' + stream.streamId);
            var streamsContainer = document.getElementById('video');
            streamsContainer.appendChild(div);
            var divProps = {width: 500, height:315};
            subscriber = session.subscribe(stream, 'stream' + stream.streamId, divProps);
            $('.loading').hide();
          }

          function streamDestroyed(event) {
            $('.loading').show();
          }

      :javascript

        // Tokbox chat
        // http://www.tokbox.com/opentok/api/documentation/gettingstarted
        var apiKey = '#{Settings.apis.tokbox.key}';
        var sessionId = '#{@tokbox_session_id}';
        var token = '#{@tokbox_token}';        
         
        //TB.setLogLevel(TB.DEBUG);
        var session = TB.initSession(sessionId);
        // Listen if stream gets created again - to display in case publisher loses connection
        #{@owner ? "session.addEventListener('sessionConnected', sessionConnectedHandler);" : "session.addEventListener('streamCreated', streamCreated); session.addEventListener('streamCreated', streamDestroyed);"}
        
        session.connect(apiKey, token);

        // Start polling for questions
        var lastPolledAt = new Date();

        // can count number of people connected
        // http://www.tokbox.com/opentok/api/tools/js/documentation/api/ConnectionEvent.html

        function loadQuestions(){
          last = lastPolledAt.toISOString();
          $.ajax({
            url: '#{startup_questions_path(@startup)}.js?last=' + last,
            dataType: 'script',
            type: 'GET'
          });
          lastPolledAt = new Date();
          setTimeout(function(){
            loadQuestions();
          }, 10000);
        }

        loadQuestions();

    .span6
      .current_question
        - unless @current_question.blank?
          = render 'questions/current_question'
  .ask_a_question{:align => 'center'}
    %h2
      Have a question?
      &nbsp;
      = link_to_login "#{image_tag('twitter_white.png')} Ask the Founders!".html_safe, '#', :onclick => "$('.questions_modal').modal('show'); $('#question_content').focus(); return false;", :class => 'btn btn-large btn-success'
      &nbsp;
      = link_to image_tag('question_mark.png'), '#', :onclick => "$('.how_it_works').modal('show'); return false;"

  .tabbable
    %ul.nav.nav-tabs
      %li#questions_tab
        %a{:href => '#questions', 'data-toggle' => 'tab'}
          Questions
          %span.badge.badge-warning#question_count= @questions.size
      %li.active#profile_tab
        %a{:href => '#profile', 'data-toggle' => 'tab'} Startup Profile
    .tab-content
      .tab-pane#questions
        .questions
          = render 'questions/list'
      .tab-pane.active#profile
        = render 'startups/profile'

  .modal.questions_modal.hide
    .modal-header
      %button.close{:type => 'button', 'data-dismiss' => 'modal'} x
      %h2{:style => 'margin-bottom: 5px'} Ask the founders of #{@startup.name} a question
    .modal-body
      .question_form
        = render 'questions/form'

  .modal.how_it_works.hide
    .modal-header
      %button.close{:type => 'button', 'data-dismiss' => 'modal'} x
      %h2{:style => 'margin-bottom: 5px'} How it Works
    .modal-body
      %h3 When you ask a question it is tweeted from your Twitter account.
      %p We do this so that people only ask questions that they think are good. Also, the point of demo day is to bring attention to great founders. This rewards the founders you are interested in by sharing with your followers.

      %h3 Questions are ranked by the number of followers who saw it.
      %p When a question is asked, it gets ranked based on the number of followers of the asker. After a question is asked (and before it is answered) other people can support the question (re-tweet it).

      %h3 Supporting a question upvotes it (and gets it answered sooner).
      %p When a question is "supported", that question is seen by their followers and therefore gets added to the sum of followers who have seen it. That will re-rank the question and move it up in the queue so that it gets answered sooner.
    .modal-footer
      %center
        = link_to_login "#{image_tag('twitter_white.png')} Ask a question!".html_safe, '#', :onclick => "$('.how_it_works').modal('hide'); $('.questions_modal').modal('show'); $('#question_content').focus(); return false;", :class => 'btn btn-large btn-success'